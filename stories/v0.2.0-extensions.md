# Story: v0.2.0 zigFP 扩展模块

> 实现增强迭代器、累积验证和 Free Monad

## 目标

扩展 zigFP 库，添加更高级的函数式编程抽象：
- Iterator - 函数式迭代器
- Validation - 累积错误验证
- Free Monad + Trampoline - 可解释 DSL 和栈安全递归

## 验收标准

### Iterator 模块 (iterator.zig)

- [x] `SliceIterator` - 从切片创建迭代器
- [x] `MapIterator` - 映射转换
- [x] `FilterIterator` - 过滤元素
- [x] `TakeIterator` - 取前 n 个
- [x] `SkipIterator` - 跳过前 n 个
- [x] `RangeIterator` - 数字范围
- [x] `RepeatIterator` - 无限重复
- [x] `ZipIterator` - 合并两个迭代器
- [x] `EnumerateIterator` - 添加索引
- [x] 终端操作：`fold`, `sum`, `product`
- [x] 终端操作：`max`, `min`, `find`
- [x] 终端操作：`all`, `any`, `count`
- [x] 终端操作：`collect`
- [x] `reset` - 重置迭代器
- [x] 单元测试 (19 tests)

### Validation 模块 (validation.zig)

- [x] `Validation(T, E)` 类型定义
- [x] 构造器：`valid`, `invalid`, `invalidMany`
- [x] 查询：`isValid`, `isInvalid`, `getValue`, `getErrors`
- [x] `getOrElse` - 获取值或默认值
- [x] Functor：`map`
- [x] `mapErrors` - 转换错误类型
- [x] Applicative：`ap`
- [x] `combine` - 组合两个 Validation（累积错误）
- [x] `toResult` - 转换为 Result
- [x] `fold` - 处理两种情况
- [x] `validateAll` - 批量验证
- [x] 内置验证器：`notEmpty`
- [x] 内置验证器：`positive`, `nonZero`
- [x] 单元测试 (14 tests)

### Free Monad 模块 (free.zig)

- [x] `Free(F, A)` 类型定义
- [x] 构造器：`pure`, `liftF`
- [x] 查询：`isPure`, `isSuspend`, `getValue`
- [x] `Trampoline(A)` - 栈安全递归
- [x] Trampoline 构造器：`done`, `more`
- [x] Trampoline `run` - 执行到完成
- [x] `Program(A)` - 简化 DSL 示例
- [x] `ConsoleF`, `ConsoleIO` - Console DSL
- [x] `printLine`, `readLine` - Console 操作
- [x] 单元测试 (9 tests)

### 文档

- [x] `docs/iterator.md` - Iterator 文档
- [x] `docs/validation.md` - Validation 文档
- [x] `docs/free.md` - Free Monad 文档

### 集成

- [x] `root.zig` 导出所有新模块
- [x] ROADMAP.md 更新
- [x] README.md 更新
- [x] `zig build test` 通过 (174 tests)
- [x] 无内存泄漏

## 任务分解

### Phase 1: Iterator
1. 实现 `src/iterator.zig`
2. 实现基础迭代器类型
3. 实现终端操作
4. 添加测试

### Phase 2: Validation
5. 实现 `src/validation.zig`
6. 实现 Applicative 操作
7. 实现内置验证器
8. 添加测试

### Phase 3: Free Monad
9. 实现 `src/free.zig`
10. 实现 Trampoline
11. 实现 DSL 示例
12. 添加测试

### Phase 4: 集成
13. 更新 `src/root.zig`
14. 创建文档
15. 更新 ROADMAP.md 和 README.md
16. 运行完整测试

## 技术说明

### Zig 0.15 兼容性

- ArrayList 使用 `initCapacity(allocator, n)` 初始化
- ArrayList 的 `append`, `toOwnedSlice` 等需要传入 allocator
- `deinit(allocator)` 需要 allocator 参数

### 设计决策

1. **Iterator**: 使用具体类型而非 trait，因为 Zig 不支持 trait
2. **Validation**: Applicative 而非 Monad，因为累积错误需要并行执行
3. **Free Monad**: 简化实现，由于 Zig 类型系统限制

## 完成状态

- 开始日期: 2026-01-02
- 完成日期: 2026-01-02
- 状态: ✅ 已完成
- 测试结果: 174 tests passed (42 new tests for v0.2.0)
