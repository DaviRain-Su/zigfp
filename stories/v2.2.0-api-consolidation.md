# Story: v2.2.0 API 整合与重构

> 统一 API 设计，消除重复实现，提升代码一致性

## 目标

1. 消除 Option 操作的重复实现
2. 统一 Alternative/Functor 操作的 API 风格
3. 明确 Either 和 Result 的用途区分
4. 添加缺失的核心方法到 Option 类型

## 背景

当前代码存在以下问题：

1. **重复实现**:
   - `Option.or()` vs `alternative.option.orOp()` vs `orOption()`
   - `flattenOption()` vs `distributeOption()` - 功能相同
   - `Option.None()` vs `alternative.option.empty()` vs `emptyOption()`

2. **API 不一致**:
   - 有些操作在 Option 类型内部（方法）
   - 有些操作作为外部函数
   - 便捷函数有时重复实现而非调用核心方法

3. **Either vs Result**:
   - 结构几乎相同，需要明确区分用途

## 验收标准

### Option 类型增强 (core/option.zig)

- [x] 添加 `flatten` 函数 - 展平嵌套 Option
- [x] 验证现有 `or` 方法符合 Alternative 语义
- [x] 单元测试 (3 tests)

### Alternative 整合 (algebra/alternative.zig)

- [x] `alternative.option.orOp` 调用 `Option.or()` 而非重复实现
- [x] `orOption` 便捷函数调用 `Option.or()` 而非重复实现
- [x] 保持 `many`/`some`/`optional` 作为扩展操作
- [x] 单元测试保持通过

### Natural Transformation 整合 (functor/natural.zig)

- [x] `flattenOption` 调用 `option_mod.flatten()` 而非独立实现
- [x] 保持其他自然变换函数不变
- [x] 单元测试保持通过

### Distributive 整合 (functor/distributive.zig)

- [x] `distribute` 调用 `option_mod.flatten()` 而非独立实现
- [x] 单元测试保持通过

### Either 用途文档 (functor/bifunctor.zig)

- [x] 添加文档注释说明 Either vs Result 的区别
- [x] Either 用于 Bifunctor/Profunctor 抽象
- [x] Result 用于错误处理

### 导出更新

- [x] core/mod.zig 导出 flatten
- [x] root.zig 导出 flatten

### 集成

- [x] 所有测试通过 (964 tests)
- [x] 无内存泄漏
- [x] CHANGELOG.md 更新
- [x] ROADMAP.md 更新

## 技术说明

### Option.flatten 实现

```zig
/// 展平嵌套的 Option
/// Option(Option(T)) -> Option(T)
pub fn flatten(comptime T: type, nested: Option(Option(T))) Option(T) {
    return switch (nested) {
        .some => |inner| inner,
        .none => Option(T).None(),
    };
}
```

### Alternative 整合

```zig
// 之前 - 重复实现
pub fn orOp(comptime A: type, fa: Option(A), fb: Option(A)) Option(A) {
    if (fa.isSome()) return fa;
    return fb;
}

// 之后 - 委托给核心方法
pub fn orOp(comptime A: type, fa: Option(A), fb: Option(A)) Option(A) {
    return fa.@"or"(fb);
}
```

### Either vs Result 区分

| 类型 | 语义 | 偏向性 | 典型用途 |
|------|------|--------|---------|
| Result(T, E) | 成功/失败 | 右偏 (Ok) | 错误处理 |
| Either(A, B) | 两种可能 | 无偏向 | Bifunctor/Profunctor |

## 完成状态

- 开始日期: 2026-01-02
- 完成日期: 2026-01-02
- 状态: ✅ 已完成
