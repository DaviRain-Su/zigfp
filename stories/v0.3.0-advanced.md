# Story: v0.3.0 zigFP 高级抽象

> 实现 Continuation Monad、Effect System 和 Parser Combinators

## 目标

添加更高级的函数式编程抽象：
- Continuation Monad - 控制流抽象，支持 CPS 风格
- Effect System - 代数效果系统，分离效果描述与处理
- Parser Combinators - 组合式解析器

## 验收标准

### Continuation Monad (cont.zig)

- [x] `Cont(R, A)` 类型定义 - Continuation Monad
- [x] 构造器：`pure`
- [x] `runCont` - 执行 continuation
- [x] `getValue` - 获取内部值
- [x] Functor：`map`
- [x] Monad：`flatMap`
- [x] `andThen` - 序列操作
- [x] `zip` - 组合两个 Continuation
- [x] `CPS(A, R)` - CPS 风格函数类型
- [x] `TrampolineCPS(A)` - 栈安全递归
- [x] `loop` - 循环执行
- [x] `when` - 条件执行
- [x] `toCPS` - 普通函数转 CPS
- [x] `identityCPS` - CPS identity
- [x] `composeCPS` - CPS 风格 compose
- [x] 单元测试 (19 tests)
- [x] Monad 法则验证

### Effect System (effect.zig)

- [x] `Effect(E, A)` 类型定义
- [x] `EffectTag` - 效果类型标记
- [x] `pure` - 纯值
- [x] `perform` - 执行效果
- [x] `isPure` / `getValue` - 查询方法
- [x] Functor：`map`
- [x] Monad：`flatMap`, `andThen`
- [x] `Handler(E, A, R)` - 效果处理器
- [x] `handle` - 处理效果
- [x] `runPure` - 运行纯计算
- [x] 内置效果：`ReaderEffect`, `StateEffect`, `ErrorEffect`, `LogEffect`
- [x] `Combined` / `EffectList` - 效果组合
- [x] 单元测试 (16 tests)
- [x] Monad 法则验证

### Parser Combinators (parser.zig)

- [x] `Parser(T)` 类型定义
- [x] `ParseResult(T)` - 解析结果
- [x] `ParseError` - 解析错误
- [x] 基础解析器：
  - [x] `char` - 单字符
  - [x] `anyChar` - 任意字符
  - [x] `satisfy` - 满足条件
  - [x] `digit` - 数字
  - [x] `letter` - 字母
  - [x] `alphaNum` - 字母或数字
  - [x] `whitespace` - 空白
  - [x] `string` - 字符串
  - [x] `eof` - 文件结束
  - [x] `integer` - 整数
- [x] 组合子：
  - [x] `map` - 转换结果
  - [x] `flatMap` - 链式解析
  - [x] `andThen` - 序列（返回第二个）
  - [x] `andSkip` - 序列（返回第一个）
  - [x] `alt` - 选择
  - [x] `optional` - 可选
  - [x] `many` - 零或多个
  - [x] `many1` - 一或多个
  - [x] `skipWhitespace` - 跳过空白
- [x] `pure` - 始终成功
- [x] `fail` - 始终失败
- [x] 单元测试 (20 tests)

### 文档

- [x] `docs/cont.md` - Continuation 文档
- [x] `docs/effect.md` - Effect System 文档
- [x] `docs/parser.md` - Parser Combinators 文档

### 集成

- [x] `root.zig` 导出所有新模块
- [x] ROADMAP.md 更新
- [x] README.md 更新
- [x] `zig build test` 通过
- [x] 无内存泄漏

## 技术说明

### Continuation Monad

由于 Zig 不支持闭包，采用简化实现：
- `Cont(R, A)` 使用值包装而非函数包装
- `CPS(A, R)` 提供真正的 CPS 风格函数
- `TrampolineCPS(A)` 提供栈安全递归
- 提供 `toCPS`、`identityCPS`、`composeCPS` 等工具函数

```zig
// 使用示例
const c = Cont(i32, i32).pure(42);
const result = c.runCont(struct {
    fn k(x: i32) i32 { return x * 2; }
}.k);  // 84
```

### Effect System

基于代数效果的设计：
- 效果是操作的描述，不是实现
- `Handler` 定义如何处理效果
- 支持效果组合和局部处理
- 内置 Reader、State、Error、Log 效果

```zig
// 使用示例
const ErrEff = ErrorEffect([]const u8, i32);
const eff = ErrEff.throw("error!");
const result = ErrEff.runError(eff);  // .{ .err = "error!" }
```

### Parser Combinators

基于 Parsec 风格的组合式解析器：
- 解析器是一等公民
- 通过组合构建复杂解析器
- 由于 Zig 限制，部分组合子（map、flatMap）简化实现
- `many`/`many1` 需要 allocator

```zig
// 使用示例
const p = integer();
const result = p.parse("-123abc");
// result.getValue() = -123
// result.getRemaining() = "abc"
```

## 完成状态

- 开始日期: 2026-01-02
- 完成日期: 2026-01-02
- 状态: ✅ 已完成
