# Story: v1.9.0 数据结构增强

> 添加更多函数式数据结构：NonEmptyList、These、Validated 增强

## 目标

1. 实现 NonEmptyList - 保证非空的列表类型
2. 实现 These - 同时持有两个值的类型（类似 Haskell 的 These）
3. 增强 Validated - 更多验证组合器
4. 添加更多数据操作工具

## 验收标准

### NonEmptyList (data/non_empty.zig)

- [x] `NonEmptyList(T)` - 非空列表类型
- [x] `head` - 获取第一个元素（总是成功）
- [x] `tail` - 获取剩余元素
- [x] `last` - 获取最后一个元素
- [x] `init` - 通过 fromSlice 创建
- [x] `toSlice` - 转换为切片
- [x] `fromSlice` - 从切片创建（返回 Option）
- [x] `singleton` - 单元素列表
- [x] `cons` - 在头部添加元素
- [x] `append` - 连接两个非空列表
- [x] `map` - 映射操作
- [x] `foldl`/`foldr` - 折叠操作
- [x] `foldl1`/`foldr1` - 无初始值折叠
- [x] `reverse` - 反转
- [x] `snoc` - 在尾部添加元素
- [x] `filter` - 过滤操作
- [x] `all`/`any` - 全部/存在检查
- [x] `find` - 查找元素
- [x] `forEach` - 遍历执行副作用
- [x] 单元测试 (20+ tests)

### These (data/these.zig)

- [x] `These(A, B)` - This A | That B | Both A B
- [x] `This` - 只有 A
- [x] `That` - 只有 B  
- [x] `Both` - 同时有 A 和 B
- [x] `isThis`/`isThat`/`isBoth` - 类型检查
- [x] `getThis`/`getThat`/`getBoth` - 访问器
- [x] `fromResult` - 从 Result 转换
- [x] `toOptionPair` - 转换为 Option 对
- [x] `fromOptions` - 从两个 Option 创建
- [x] `mapThis`/`mapThat` - 单边映射
- [x] `bimap` - 双向映射
- [x] `fold` - 折叠
- [x] `mergeWith` - 使用函数合并
- [x] `swap` - 交换 A 和 B
- [x] `thisOr`/`thatOr` - 默认值获取
- [x] 单元测试 (15+ tests)

### Validated 增强 (core/validation.zig)

- [x] `invalidOne` - 从单个错误创建
- [x] `mapValidation` - 映射有效值
- [x] `flatMapValidation` - 扁平映射
- [x] `ensure` - 确保条件成立
- [x] `fromOption` - 从 Option 转换
- [x] `fromResult` - 从 Result 转换
- [x] `toResult` - 转换为 Result
- [x] 单元测试

### 集成

- [x] data/mod.zig 导出
- [x] core/mod.zig 更新
- [x] root.zig 导出
- [x] 文档更新 (CHANGELOG.md)
- [x] 所有测试通过 (872 tests)

## 技术说明

### NonEmptyList 设计

```zig
pub fn NonEmptyList(comptime T: type) type {
    return struct {
        head_val: T,
        tail_items: []const T,  // 可以为空

        // head 总是存在，所以 NonEmptyList 永远非空
        pub fn head(self: Self) T {
            return self.head_val;
        }
    };
}
```

### These 设计

```zig
pub fn These(comptime A: type, comptime B: type) type {
    return union(enum) {
        this: A,       // 只有 A
        that: B,       // 只有 B
        both: struct { a: A, b: B },  // 同时有 A 和 B
    };
}
```

### 使用示例

```zig
// NonEmptyList
const nel = NonEmptyList(i32).singleton(allocator, 1);
const nel2 = try nel.snoc(allocator, 2);  // [1, 2]
const sum = nel.foldl1(add);  // 无需初始值

// These - 用于合并操作
const this = These(i32, []const u8).This(42);
const both = These(i32, []const u8).Both(42, "hello");
const result = both.fold(showInt, showStr, showBoth);

// Validated 增强
const v = try validationFromOption(i32, []const u8, opt, allocator, "missing");
const v2 = try ensureValidation(i32, []const u8, v, allocator, isPositive, "must be positive");
```

## 完成状态

- 开始日期: 2026-01-02
- 完成日期: 2026-01-02
- 状态: ✅ 已完成
